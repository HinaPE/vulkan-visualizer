# Vulkan Visualizer 开发路线图（面向物理模拟可视化）

最后更新时间：2025-09-21

本路线图基于当前仓库的 Vulkan 引擎代码仔细阅读与分析，目标是在“不引入任何物理仿真逻辑”的前提下，把本项目发展为一个独立、通用、适配多类物理模拟数据的可视化器（Visualizer）。

---

## 1. 当前代码能力与结构解读

以下结论来自对 `include/vk_engine.h`、`src/vk_engine.cpp`、`examples/basic_window.cpp` 的通读与梳理。

- 核心依赖与版本
  - Vulkan 1.3，动态渲染（Dynamic Rendering）、时间线信号量（Timeline Semaphore）、同步2（Synchronization2）路径已使用。
  - 第三方：SDL3（窗口与输入）、vk-bootstrap（实例/设备/交换链建造器）、VMA（显存分配）、ImGui（带 Docking + 多窗口 Viewports）。
  - CMake 构建，示例里通过预编译 SPIR-V 的路径加载着色器。

- 引擎抽象与职责
  - `IRenderer`：应用侧渲染器接口，包含能力协商（`query_required_device_caps`/`get_capabilities`）、初始化/销毁、事件/更新/记录命令、（可选）异步计算、ImGui 绘制、统计等。
  - `RendererCaps`：渲染器与引擎协商的契约，包含帧并发、是否用深度、离屏附件（可多 RT）、呈现模式（直出/引擎 Blit/渲染器合成）、格式与扩展需求（RT、AS、Mesh Shader 等开关）。
  - 呈现模式：`EngineBlit`（引擎把离屏 HDR 颜色 Blit 到交换链）、`RendererComposite`（渲染器负责合成）、`DirectToSwapchain`。
  - 资源：引擎根据渲染器的 `AttachmentRequest` 创建离屏颜色/深度图像及视图；含一个简单的 `DescriptorAllocator`（单池，轻量）。
  - 帧循环：
    - SDL 事件分发给渲染器与 ImGui；处理最小化/焦点/尺寸变化。
    - 支持交换链重建，动态重建离屏附件，并回调渲染器 `on_swapchain_ready/…destroy`。
    - 支持可选异步计算队列（独立 command buffer + semaphore 提前提交）。
    - 引擎内置 ImGui 渲染（覆盖层在交换链图像上以动态渲染绘制）。
  - 同步：每帧用时间线信号量确保上一帧完成；呈现 1 帧并发（`FRAME_OVERLAP=2`）。

- 示例现状
  - `examples/basic_window.cpp` 提供一个最小三角形渲染器，采用动态渲染，演示 pipeline 创建与在离屏颜色附件上清屏+绘制，再由引擎 blit 到交换链。

- 明确的空白/未提供能力（与“可视化器”目标相关）
  - 数据接入/流式更新：缺少数据导入接口、持久映射/上传环形缓冲、文件监视、远程控制/管道等。
  - 基础场景/相机/交互：没有统一的相机控制（轨道/飞行）、坐标轴/网格、选择/拾取、测量、裁剪、时间轴控制等。
  - 通用图元与渲染套件：缺少点云、线段/折线、箭头/张量 glyph、粒子/实例化、体渲染/切片、透明度与 OIT、色标/传递函数、文本标注。
  - 资源与工具：缺少缓冲/纹理管理器、着色器系统（编译/热更）、截图/视频序列、GPU 时间戳分析、日志/统计面板拓展、截图/离屏高分辨率渲染。
  - 扩展性：`EngineContext.services` 已预留 `void*`，但无正式服务接口；无插件化/脚本化入口。

---

## 2. 范围与原则

- 范围：只建设“可视化器”所需的渲染、交互、数据接入与工具模块，不加入任何物理求解/计算逻辑。
- 保持引擎与渲染器解耦：引擎提供共用设施（上传、查询、截图、热更、面板），渲染器专注具体可视化策略。
- 非目标：不做复杂 DCC/场景编辑器；不耦合某一特定仿真框架；不强制 PBR 级别材质体系（优先实用的科学可视化通道）。

---

## 3. 里程碑式开发计划

### M0 基础打牢（健壮性与可用性）

目标：让现有引擎成为稳定“壳”，提供必要通用服务，支撑后续快速堆叠特性。

- 日志与错误处理
  - 统一日志宏/等级、可选文件输出，Vulkan 错误信息串联到日志。
  - ImGui HUD 增加日志窗口。
- 配置与工程卫生
  - CMake 选项化特性开关（Imgui/Async Compute/RT 等）。
  - 工具链与第三方版本锁定说明，基础文档完善。
- GPU 时间戳/统计
  - 引擎内置 QueryPool 包装，渲染器可选记录 GPU 时间，HUD 展示 CPU/GPU 时序。
- 着色器与资源热更
  - 简单文件监视（watcher），变动后重载 SPIR-V/常量缓冲/纹理。
- 截图能力
  - 引擎层提供将交换链或离屏附件保存为 PNG/EXR（根据格式）的工具；渲染器可调用 `request_screenshot`。
- Tone mapping/颜色空间
  - 引擎 Blit 路径提供可选 Tone Mapping（曝光/曲线）与 Gamma 修正（sRGB），保持 HDR 离屏渲染→LDR 显示质量。

验收：
- 示例程序含 HUD 中可见 GPU/CPU 计时、日志面板；
- 修改着色器文件能热更；
- 一键截图成功；
- Tone Mapping 开关可见效果变化。

---

### M1 数据接入与场景基础

目标：确立“如何把外部仿真数据喂给可视化器”的路径，并具备最基础场景管理与相机交互。

- Engine Services（正式化）
  - 将 `EngineContext.services` 定义为结构体指针，例如：
    - UploadContext（持久映射 staging、上传队列/栅栏、双/三缓冲）
    - ShaderManager（文件监视+加载/重载）
    - TimestampQueryService（GPU 计时）
    - ScreenshotService（截图/序列）
    - FileWatcher（跨平台）
    - DebugDraw（线/点基础 Gizmo）
- 数据输入通道（首版）
  - 文件拉取：支持 JSON + 二进制块的简易格式（例：位置/标量/颜色的帧序列），带目录监听自动加载最新帧。
  - API 层：在渲染器中以回调拉取/提交数据批次，示例提供导入器。
- 场景与相机
  - 轻量 Scene/Node/Transform（平铺也可）+ 观察者相机（轨道/飞行）、相机书签；
  - 事件绑定：SDL 输入到相机控制（平移/旋转/缩放）、复位。
- 基础图元渲染管线
  - 三类最通用：点云（变点大小/衰减/按标量着色）、线段/折线、三角网格（基本材质/单色/顶点色）。
  - 大量数据的上传路径：实例化/SSBO 批渲染、顶点/索引缓冲的流式更新。

验收：
- 提供 “粒子点云 + 折线 + 网格” 的多通道可视化示例，支持连续帧文件加载；
- 相机操作流畅，百万级点云下仍可交互（>30 FPS，依硬件）。

---

### M2 科学可视化增强（标量/向量/张量）

目标：面向常见物理场的表达能力。

- 标量场与色标
  - 统一色标/传递函数系统（预设 + 自定义），色标条（color bar）HUD；
  - 将点/线/网格按标量映射颜色，支持范围锁定/自动。
- 向量/张量可视化
  - 箭头/圆锥体 glyph（方向+大小），椭球体/盒子表示张量主轴（可选）；
  - 轨迹/尾迹（motion trails）。
- 裁剪与切片
  - 任意裁剪平面（可交互），网格/点云切片；
  - 体数据切片（若有三维标量体，先做二维切片/多平面）。
- 透明度与混合
  - 采用 Weighted Blended OIT（实用的近似 OIT），保证粒子/半透明几何叠加的一致性。
- 文本/标注
  - 屏幕空间文本、数据点标签、注释箭头；
  - 局部单位/比例尺/坐标轴。

验收：
- 点/线/网格支持“按标量着色+色标条显示”；
- 箭头 glyph（实例化）渲染稳定；
- 裁剪平面可交互开启/移动；
- 半透明叠加视觉合理；
- 支持屏幕文字与基本标注。

---

### M3 交互、选择与测量

目标：提升分析效率与可用性。

- 拾取/选择
  - 光线拾取（网格三角、点最近邻）、选择集管理；
  - 选中高亮、属性查看（ID、标量、向量等）。
- 测量与辅助
  - 距离/角度/夹角测量；
  - 参考坐标轴/网格、包围盒显示；
  - 相机对齐/正交视图快速切换。
- 时间轴/播放控制
  - 播放/暂停/步进、播放速度、循环区间；
  - “拍照轨迹”：相机会随时间采样/插值。

验收：
- 可稳定拾取点/三角形并显示属性；
- 可在 HUD 上进行测量并导出结果；
- 时间轴可驱动数据帧切换与相机轨迹。

---

### M4 I/O 与自动化

目标：更好地融入仿真工作流与产出能力。

- 数据格式与插件
  - 扩展导入器：PLY/OBJ/GLB（网格/点云）、CSV（二进制加速版）、VTK（若合适，可先子集）。
  - 插件接口：动态加载导入器（可选）。
- 会话与配置
  - 可保存/加载当前相机、图层可见性、色标、裁剪等会话；
  - 命令行参数控制：打开数据、设置输出目录、无头渲染。
- 截图/视频序列
  - 高分辨率离屏渲染（超采样/分块）、PNG/EXR 序列；
  - 帧号/时间戳管理，批量导出；
  - 基本视频编码（可选：外部 ffmpeg 管道）。
- 远程控制与无头模式
  - 简易本地 HTTP/WS 控制接口（切帧/相机/截图）；
  - 无头渲染（创建 surface-less swapchain 或离屏帧缓冲），用于 CI 批渲染。

验收：
- 可通过命令行与简单 HTTP 调用自动渲染若干帧并导出；
- 支持 2×/4× 超采样离屏输出；
- 会话文件可准确复现视图。

---

### M5 性能与稳定性

目标：大数据场景的稳健性与性能。

- 性能
  - 视锥剔除、实例化批渲染；
  - 大顶点/索引数据的分块与分页；
  - 可选异步计算队列参与数据预处理（排序、缩放）。
- 稳定性
  - 压力测试（上亿粒子分层加载）、冗余防御（Out-of-date、设备丢失恢复策略）；
  - 自动化基准与回归测试；
  - 显存预算/报警（VMA 预算 HUD 已有，完善为阈值提示）。

验收：
- 在给定硬件上通过若干规模基准（定义目标 FPS）；
- CI 跑通若干无头基准渲染并比对哈希。

---

### M6 扩展性与易用性

目标：让生态可持续扩展，团队/用户易接入。

- 插件/脚本
  - 渲染器插件样例工程；
  - Lua/Python 轻量脚本接口（相机/时间轴/截图控制）。
- UI/UX
  - ImGui 主题与布局预设；
  - 统一设置面板（数据、渲染、相机、输出）。
- 文档与示例
  - 面向“仿真团队”的接入指南（数据格式、调用 API、自动化示例）。

验收：
- 提供脚本样例完成“加载→播放→截图序列”；
- 示例工程可快速复制定制。

---

## 4. 关键模块设计草案（对现有代码的最小侵入扩展）

结合当前引擎接口，建议以“引擎服务 + 渲染器实现”的方式渐进落地。

- EngineServices（通过 `EngineContext.services` 提供）
  - UploadContext：
    - 持久映射 staging（`VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT | HOST_COHERENT`），环形分配；
    - GPU 侧拷贝/栅栏编排（复用现有队列/时间线）；
  - ShaderManager：文件监视、SPIR-V 重载、宏定义/变体管理；
  - TimestampQueryService：封装 QueryPool、分帧查询与 HUD 展示；
  - ScreenshotService：读取图像到 CPU（支持 R16G16B16A16 → EXR），保存到磁盘；
  - DebugDraw：简单线段/点的即时模式（辅助 gizmo/测量/拾取可视化）。

- 渲染通道与附件
  - 保持 `RendererCaps` 的离屏附件协商机制，新增：
    - 可选 MSAA（`color_samples`）与解析流程；
    - OIT 需要的附加缓冲（例如累积/权重 RT）。

- 统一图元库
  - 点云、线段、三角网：统一的 Vertex/Instance 缓冲布局与绑定；
  - 实例化渲染（transform/颜色/标量等属性在 SSBO/InstanceBuffer 中），支持按标量改变大小/颜色。

- 交互
  - 相机控制模块（渲染器可复用）：轨道/飞行、加速、惯性（可选）；
  - 拾取：屏幕射线 → BVH（可后续），首版采用 CPU 粗略测试+GPU ID 渲染回读。

- 可视化工具
  - 色标/传递函数：集中管理、支持预设（Viridis、Plasma、Turbo、Rainbow 等）；
  - Glyph 管线：箭头/椭球（实例网格或几何着色器，优先实例网格）。

- I/O 与会话
  - 简易二进制帧格式（header + blocks），目录轮询/监听；
  - 会话 JSON：保存相机/图层/色标/裁剪等。

这些模块尽量以独立 cpp/h 组织，减少对 `vk_engine.cpp` 的侵入，仅通过 `EngineContext.services` 与 `IRenderer` 交互。

---

## 5. 风险与取舍

- 透明度与排序：大规模粒子透明排序成本高，建议落地 Weighted Blended OIT 作为首选方案。
- 体渲染：若无明确需求，可延后完整体积光线投射，仅先实现多切片浏览。
- 拾取精度：首版可采用 ID Pass 回读像素，性能与准确度可接受；BVH/RTX 拾取作为后续优化。
- 多平台：当前工程偏 Windows/MSVC，后续 Linux 支持需验证 SDL3/Vulkan 驱动差异与字体/路径处理。

---

## 6. 示例与测试计划

- 示例场景
  - 粒子（百万级点云，按速度/温度着色，带色标条）；
  - 网格 + 裁剪平面 + 标注；
  - 向量场箭头 glyph；
  - 时间轴驱动的帧序列播放与截图序列导出。

- 自动化与基准
  - 无头渲染 N 帧固定场景，图像 Hash 比对回归；
  - 数据规模阶梯（10万/100万/500万点）性能采样；
  - 着色器热更/重载的稳定性测试。

---

## 7. 预估排期（粗略，按人月）

- M0：1–2 周
- M1：3–4 周
- M2：4–6 周（可按需求裁剪）
- M3：2–3 周
- M4：3–5 周
- M5：持续优化（并行推进）
- M6：1–2 周

注：具体取决于团队规模、既有代码复用程度与目标数据规模。

---

## 8. 与当前仓库的改动点总览（最小集合）

- 新增 `engine_services/`（UploadContext/ShaderManager/Timestamp/Screenshot/DebugDraw 等子模块）。
- 轻改 `vk_engine.h/.cpp`：
  - 将 `EngineContext.services` 指向 `EngineServices`；
  - 在 HUD 中接入 GPU 时间戳与显存预算扩展展示；
  - 引擎 Blit 支持可选 Tone Mapping 与 Gamma；
  - 增加截图对外入口（供渲染器调用）。
- 新增 `primitives/`（points/lines/mesh 渲染器小库，含实例化与按标量着色）。
- 新增 `examples/physics_viz_demo/`：展示数据加载、时间轴、相机、色标/裁剪/截图。

---

## 9. 成功标准（对物理模拟可视化的契合度）

- 能以“零仿真逻辑”的方式加载/播放来自外部的帧数据（文件/远程后续）。
- 提供点/线/面等基础图元的高效渲染与按场数据（标量/向量）映射的表达能力。
- 提供实用的分析工具（相机/选择/测量/裁剪/色标/截图/视频序列）。
- 面向大数据具备稳定帧率与可扩展上传路径（环形 staging + 分块）。
- 引擎与渲染器隔离良好，后续可通过插件/脚本扩展能力而无需改动底层。

---

如需我基于此路线图先落地 M0/M1 的骨架代码与示例，请告知优先级与目标平台/数据规模，我会直接在仓库中搭建对应模块与演示。
